# ecmc test system
# Anders Sandstr√∂m

require ecmccfg ILK,"EC_RATE=5000,ECMC_VER=ILK"

ecmcConfigOrDie "Cfg.EcSetDelayECOkAtStartup(1000)"

# Configure hardware
${SCRIPTEXEC} ${ecmccfg_DIR}addSlave.cmd, "SLAVE_ID=1, HW_DESC=EL3004"
${SCRIPTEXEC} ${ecmccfg_DIR}addSlave.cmd, "SLAVE_ID=2, HW_DESC=EL5001"
${SCRIPTEXEC} ${ecmccfg_DIR}addSlave.cmd, "SLAVE_ID=3, HW_DESC=EL1008"
${SCRIPTEXEC} ${ecmccfg_DIR}configureSlave.cmd, "SLAVE_ID=4, HW_DESC=EL7031, CONFIG=-Motor-Trinamic-QMot-QSH4218-41-10-035"

# Add some ec data items that access first and second byte of positionActual01
${SCRIPTEXEC} ${ecmccfg_DIR}addEcDataItem.cmd "STRT_ENTRY_NAME=positionActual01,OFFSET_BYTE=0,OFFSET_BITS=0,RW=2,DT=B4,NAME=PosAct01_b1,FIELDS='EGU=Counts'"
${SCRIPTEXEC} ${ecmccfg_DIR}addEcDataItem.cmd "STRT_ENTRY_NAME=positionActual01,OFFSET_BYTE=1,OFFSET_BITS=0,RW=2,DT=B4,NAME=PosAct01_b2,FIELDS='EGU=Counts'"
${SCRIPTEXEC} ${ecmccfg_DIR}addEcDataItem.cmd "STRT_ENTRY_NAME=positionActual01,OFFSET_BYTE=0,OFFSET_BITS=1,RW=2,DT=S32,NAME=PosAct01_b3,FIELDS='EGU=Counts'"

${SCRIPTEXEC} ${ecmccfg_DIR}addEcDataItem.cmd "STRT_ENTRY_NAME=positionActual01,OFFSET_BYTE=0,OFFSET_BITS=1,RW=2,DT=S32,NAME=PosAct01_b4,FIELDS='EGU=Counts',REC_TYPE=AI"
${SCRIPTEXEC} ${ecmccfg_DIR}addEcDataItem.cmd "STRT_ENTRY_NAME=positionActual01,OFFSET_BYTE=0,OFFSET_BITS=1,RW=1,DT=S32,NAME=PosAct01_b5,FIELDS='EGU=Counts',REC_TYPE=AO"
${SCRIPTEXEC} ${ecmccfg_DIR}addEcDataItem.cmd "STRT_ENTRY_NAME=positionActual01,OFFSET_BYTE=0,OFFSET_BITS=1,RW=2,DT=S32,NAME=PosAct01_b6,FIELDS='EGU=Counts',REC_TYPE=BI"
${SCRIPTEXEC} ${ecmccfg_DIR}addEcDataItem.cmd "STRT_ENTRY_NAME=positionActual01,OFFSET_BYTE=0,OFFSET_BITS=1,RW=1,DT=S32,NAME=PosAct01_b7,FIELDS='EGU=Counts',REC_TYPE=BO"
${SCRIPTEXEC} ${ecmccfg_DIR}addEcDataItem.cmd "STRT_ENTRY_NAME=positionActual01,OFFSET_BYTE=0,OFFSET_BITS=1,RW=2,DT=S32,NAME=PosAct01_b8,FIELDS='EGU=Counts',REC_TYPE=LONGIN"
${SCRIPTEXEC} ${ecmccfg_DIR}addEcDataItem.cmd "STRT_ENTRY_NAME=positionActual01,OFFSET_BYTE=0,OFFSET_BITS=1,RW=1,DT=S32,NAME=PosAct01_b9,FIELDS='EGU=Counts',REC_TYPE=LONGOUT"
${SCRIPTEXEC} ${ecmccfg_DIR}addEcDataItem.cmd "STRT_ENTRY_NAME=positionActual01,OFFSET_BYTE=0,OFFSET_BITS=1,RW=2,DT=S32,NAME=PosAct01_b10,FIELDS='EGU=Counts',REC_TYPE=MBBI"
${SCRIPTEXEC} ${ecmccfg_DIR}addEcDataItem.cmd "STRT_ENTRY_NAME=positionActual01,OFFSET_BYTE=0,OFFSET_BITS=1,RW=1,DT=S32,NAME=PosAct01_b11,FIELDS='EGU=Counts',REC_TYPE=MBBO"
${SCRIPTEXEC} ${ecmccfg_DIR}addEcDataItem.cmd "STRT_ENTRY_NAME=positionActual01,OFFSET_BYTE=0,OFFSET_BITS=1,RW=2,DT=S32,NAME=PosAct01_b12,FIELDS='EGU=Counts',REC_TYPE=MBBIDIRECT"
${SCRIPTEXEC} ${ecmccfg_DIR}addEcDataItem.cmd "STRT_ENTRY_NAME=positionActual01,OFFSET_BYTE=0,OFFSET_BITS=1,RW=1,DT=S32,NAME=PosAct01_b13,FIELDS='EGU=Counts',REC_TYPE=MBBODIRECT"

ecmcConfigOrDie "Cfg.EcApplyConfig(1)"

# Configure Motion
epicsEnvSet("DEV",      "$(IOC)")
${SCRIPTEXEC} ${ECMC_CONFIG_ROOT}loadYamlAxis.cmd,   "FILE=cfg/stepper.yaml"

# Debug PLC
#$(SCRIPTEXEC) $(ecmccfg_DIR)loadPLCFile.cmd, "PLC_ID=1, SAMPLE_RATE_MS=1000,FILE=./test.plc")

# Other
ecmcConfigOrDie "Cfg.EcSetDiagnostics(1)"
ecmcConfigOrDie "Cfg.EcEnablePrintouts(0)"
ecmcConfigOrDie "Cfg.EcSetDomainFailedCyclesLimit(100)"
ecmcConfigOrDie "Cfg.SetDiagAxisIndex(1)"
ecmcConfigOrDie "Cfg.SetDiagAxisFreq(2)"
ecmcConfigOrDie "Cfg.SetDiagAxisEnable(0)"

# go active
$(SCRIPTEXEC) ($(ecmccfg_DIR)setAppMode.cmd)
